<!DOCTYPE html>
<html>
    <head>
        <title>SNAAdmin</title>
        <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
        <link rel="manifest" href="/assets/favicon/site.webmanifest">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>

        <style>
            * {
                /* outline: 1px solid red; */
            }
        </style>

    </head>
    <body>

        <!--
        <div class="bg-white m-4">
            <div id="" class="marker mt-4 bg-blue-100">
                <div class="p-2">
                    <p class="text-lg font-semibold" onclick="makeEditable(this)">Sky and Sea Condos</p>
                    <p class="text-xs text-gray-700" onclick="makeEditable(this)">[98.3013584,7.8311951]</p>
                    <p class="mt-2 text-sm" onclick="makeEditable(this)">WHAT UPPPPPPPPPP week</p>
                    <p class="hidden">https://render.bitstrips.com/v2/cpanel/10219413-132533800_29-s1-102140752402_2-s5-v1.png?transparent=1&palette=1&width=300</p>
                </div>
                <div id="" class="sortable-container">
                    <div class="inline-block w-24 h-full m-2">
                        <div data-position="1" class="h-24 w-24">
                            <img src="assets/phuket/sea_and_sky_1.jpg" class="object-cover w-full h-full rounded-md ">                
                        </div>
                        <p class="truncate text-xs text-sm w-24" onclick="makeEditableImage(this)">/assets/phuket/sea_and_sky_1.jpg</p>
                        <button class="bg-red-400 hover:bg-red-500 text-white text-white text-sm font-semibold px-1 rounded"
                            onclick="deleteImage(this.parentElement)">
                            x
                        </button>
                    </div>

                    <div class="inline-block w-24 h-full m-2">
                        <div data-position="2" class="h-24 w-24">
                            <img src="assets/phuket/sea_and_sky_4.jpg" class="object-cover w-full h-full rounded-md ">                
                        </div>
                        <p class="truncate text-xs text-sm w-24" onclick="makeEditableImage(this)">/assets/phuket/sea_and_sky_4.jpg</p>
                        <button class="bg-red-400 hover:bg-red-500 text-white text-white text-sm font-semibold px-1 rounded"
                            onclick="deleteImage(this.parentElement)">
                            x
                        </button>
                    </div>

                    <div class="inline-block w-24 h-full m-2">
                        <div data-position="3" class="h-24 w-24">
                            <img src="assets/phuket/sea_and_sky_3.jpg" class="object-cover w-full h-full rounded-md ">                
                        </div>
                        <p class="truncate text-xs text-sm w-24" onclick="makeEditableImage(this)">/assets/phuket/sea_and_sky_2.jpg</p>
                        <button class="bg-red-400 hover:bg-red-500 text-white text-white text-sm font-semibold px-1 rounded"
                            onclick="deleteImage(this.parentElement)">                            
                            x
                        </button>
                    </div>
                </div>
                <div class="p-2">
                    <input class="image-input hidden" type="file" accept="image/*">
                    <button class="bg-blue-400 hover:bg-blue-500 text-white text-sm font-semibold py-1 px-2 rounded"
                        onclick="addImage(this)">
                        Add Image
                    </button>
                </div>
            </div>

            <div id="" class="marker hidden">
                <div class="p-2">
                    <p class="text-lg font-semibold">Sky and Sea Condos</p>
                    <p class="text-xs text-gray-700">[98.3013584,7.8311951]</p>
                </div>
            </div>

            <div id="" class="marker mt-4 bg-blue-100">
                <div class="p-2">
                    <p class="text-lg font-semibold">The Big Bhudda</p>
                    <p class="text-xs text-gray-700">[98.3128945, 7.8277395]</p>
                    <p class="mt-2 text-sm">Text caption blah blah blah blah derrrrrrr ralksdjf;laksjdf;aklsd fwopa eviaovj</p>
                    <p class="hidden">https://render.bitstrips.com/v2/cpanel/10214710-132533800_29-s1-v1.png?transparent=1&palette=1&width=300</p>
                </div>
                <div id="" class="sortable-container">
                    <div class="inline-block w-24 h-full m-2">
                        <div data-position="1" class="h-24 w-24">
                            <img src="assets/koh_tao/nang_yuan_5.jpg" class="object-cover w-full h-full rounded-md ">                
                        </div>
                        <button class="bg-red-400 hover:bg-red-500 text-white text-sm font-semibold px-1 rounded"
                            onclick="deleteImage(this.parentElement)">                            
                            x
                        </button>
                    </div>

                    <div class="inline-block w-24 h-full m-2">
                        <div data-position="2" class="h-24 w-24">
                            <img src="assets/koh_tao/nang_yuan_4.jpg" class="object-cover w-full h-full rounded-md ">                
                        </div>
                        <button class="bg-red-400 hover:bg-red-500 text-white text-sm font-semibold px-1 rounded"
                            onclick="deleteImage(this.parentElement)">                            
                            x
                        </button>
                    </div>

                    <div class="inline-block w-24 h-full m-2">
                        <div data-position="3" class="h-24 w-24">
                            <img src="assets/koh_tao/nang_yuan_3.jpg" class="object-cover w-full h-full rounded-md ">                
                        </div>
                        <button class="bg-red-400 hover:bg-red-500 text-white text-sm font-semibold px-1 rounded"
                            onclick="deleteImage(this.parentElement)">                            
                            x
                        </button>
                    </div>
                </div>
                <div class="p-2">
                    <input class="image-input hidden" type="file" accept="image/*">
                    <button class="bg-blue-400 hover:bg-blue-500 text-white text-sm font-semibold py-1 px-2 rounded"
                        onclick="addImage(this)">
                        Add Image
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white m-4">
            <div class="mt-4">
                <button class="bg-gray-400 hover:bg-gray-500 text-white text-sm font-bold py-2 px-4 rounded" onclick="dumpState()">
                    Copy Config
                </button>       
            </div>
        </div>

        -->


        <script>

            const fetchData = fetch('trip_config.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('Error fetching the file:', error);
                });
            fetchData.then(data => {
                if (data) {
                    generateHTML(data);
                    initSortable();
                    initImageListener();
                }
            })


            function makeEditableImage(element) {
                console.log("makeEditableImage()");

                // get the actual image element associated with this text input
                const imgElement = element.parentNode.querySelector('img');

                const imgSrc = imgElement.getAttribute('src');

                // save the original class name
                const textClassName = element.className

                // Create a new input element and replace original element 
                const inputElement = document.createElement("input");
                inputElement.type = "text";
                inputElement.value = element.textContent
                element.replaceWith(inputElement);

                // Focus on the input field to allow editing
                inputElement.focus();

                // Add an event listener to handle changes when the user presses Enter
                inputElement.addEventListener("keydown", function (event) {
                    if (event.key === "Enter") {
                        // Prevent the default Enter key behavior (e.g., form submission)
                        event.preventDefault();
                        
                        // Get the updated value from the input field
                        const updatedValue = inputElement.value;

                        // Create a new text element with the updated value
                        const textElement = document.createElement("p");
                        textElement.className = textClassName;
                        textElement.textContent = updatedValue;

                        // Replace the input field with the new text element
                        inputElement.replaceWith(textElement);

                        // update <img src> to the new value
                        console.log("updated value", updatedValue);

                        imgElement.setAttribute('src', updatedValue);

                        // Reattach the click event listener for editing
                        textElement.addEventListener("click", function () {
                            makeEditableImage(textElement);
                        });
                    }
                });
            }


            // Original:
            //      <p class="editable-text" onclick="makeEditable(this)">Click me to edit</p>
            // When field is active: 
            //      <input type="text">
            function makeEditable(element) {

                // save the original class name
                const textClassName = element.className

                // Create a new input element and replace original element 
                const inputElement = document.createElement("input");
                inputElement.type = "text";
                inputElement.value = element.textContent
                element.replaceWith(inputElement);

                // Focus on the input field to allow editing
                inputElement.focus();

                // Add an event listener to handle changes when the user presses Enter
                inputElement.addEventListener("keydown", function (event) {
                    if (event.key === "Enter") {
                        // Prevent the default Enter key behavior (e.g., form submission)
                        event.preventDefault();
                        
                        // Get the updated value from the input field
                        const updatedValue = inputElement.value;

                        // Create a new text element with the updated value
                        const textElement = document.createElement("p");
                        textElement.className = textClassName;
                        textElement.textContent = updatedValue;

                        // Replace the input field with the new text element
                        inputElement.replaceWith(textElement);

                        // Reattach the click event listener for editing
                        textElement.addEventListener("click", function () {
                            makeEditable(textElement);
                        });
                    }
                });
            }


            function generateHTML(data) {
                // inject this into the body 
                const HTML = `
                    <div class="bg-white m-4">
                        ${generateMarkers(data)}
                    </div>
                    <div class="bg-white m-4">
                        <div class="mt-4">
                            <button class="bg-gray-400 hover:bg-gray-500 text-white text-sm font-bold py-2 px-4 rounded" onclick="dumpState()">
                                Copy Config
                            </button>       
                        </div>
                    </div>
                `;
                document.body.innerHTML = HTML;
            }

            function generateMarkers(markers) {
                var strings = [];
                for (var i = 0; i < markers.length; i++) {
                    (markers[i].ignore) ? 
                        strings.push(generateHiddenMarker(markers[i])) : 
                        strings.push(generateMarker(markers[i]));
                }
                return strings.join("\n");
            }

            function generateHiddenMarker(marker) {
                const markerHTML = `
                    <div id="" class="marker hidden">
                        <div class="p-2">
                            <p class="text-lg font-semibold">${marker.name}</p>
                            <p class="text-xs text-gray-700">${JSON.stringify(marker.coordinates)}</p>
                        </div>
                    </div>
                `;
                return markerHTML;
            }

            function generateMarker(marker) {
                // console.log("marker:", marker);

                const markerHTML = `
                    <div id="" class="marker mt-4 bg-blue-100">
                        <div class="p-2">
                            <p class="text-lg font-semibold" onclick="makeEditable(this)">${marker.name}</p>
                            <p class="text-xs text-gray-700" onclick="makeEditable(this)">${JSON.stringify(marker.coordinates)}</p>
                            <p class="mt-2 text-sm" onclick="makeEditable(this)">${marker.captions}</p>
                            <p class="hidden">${marker.icon}</p>
                        </div>
                        <div id="" class="sortable-container">
                            ${generateMarkerImageHTML(marker.images)}
                        </div>
                        <div class="p-2">
                            <button class="bg-blue-400 hover:bg-blue-500 text-white text-sm font-semibold py-1 px-2 rounded">
                                Add Image
                            </button>
                        </div>
                    </div>
                `;
                return markerHTML;
            }

            function generateMarkerImageHTML(images) {
                var strings = [];
                for (var i = 0; i < images.length; i++) {
                    strings.push(
                        createMarkerImage(images[i])
                    );
                }
                return strings.join("\n");
            }

            function createMarkerImage(imageSrc) {
                const markerImageHTML = `
                    <div class="inline-block w-24 h-full m-2">
                        <div class="h-24 w-24">
                            <img src="${imageSrc}" class="object-cover w-full h-full rounded-md ">                
                        </div>
                        <p class="truncate text-xs text-sm w-24" onclick="makeEditableImage(this)">${imageSrc}</p>
                        <button class="bg-red-400 hover:bg-red-500 text-white text-sm font-semibold px-1 rounded"
                            onclick="deleteImage(this.parentElement)">                            
                            x
                        </button>
                    </div>
                `;
                return markerImageHTML;
            }

            // initialize the sortable list - this should apply to all Marker > Image lists
            function initSortable() {
                const sortableContainers = document.querySelectorAll('.sortable-container');
                sortableContainers.forEach((container) => {
                    const sortable = new Sortable(container, {
                        animation: 150, // Animation speed in milliseconds
                        onEnd: (evt) => {
                            // dumpState(); 
                        }, 
                    });
                });
            }

            function initImageListener() {
                const imageInputs = document.querySelectorAll('.image-input');
                imageInputs.forEach((imageInput) => {
                    imageInput.addEventListener("change", function () {
                        const selectedImage = imageInput.files[0];
                        if (selectedImage) {

                            // TODO: UPDATE THIS HARD CODE
                            const filePrefix = "assets/koh_tao";
                            const markerHTML = createMarkerImage(`${filePrefix}/${selectedImage.name}`);

                            // find the associated sibling sortable container
                            // add the created marker image to the END of the sortable container
                            const sortableContainer = imageInput.parentElement.previousElementSibling;
                            sortableContainer.insertAdjacentHTML('beforeend', markerHTML);
                        }
                    });
                });
            }

            function deleteImage(element) {
                console.log("deleteImage()", element);
                element.remove();
            }

            function addImage(element) {
                console.log("addImage()", element);
                const imageInput = element.previousElementSibling;
                imageInput.click();
            }

            function dumpState() {
                var objects = [];

                const markers = document.querySelectorAll('.marker');
                markers.forEach((marker, index) => {

                    var markerObject = {
                        name: marker.children[0].children[0].innerHTML,
                        coordinates: JSON.parse(marker.children[0].children[1].innerHTML)
                    };

                    if (marker.classList.contains('hidden')) {
                        markerObject.ignore = true;
                    } else {
                        markerObject.captions = marker.children[0].children[2].innerHTML;
                        markerObject.icon = marker.children[0].children[3].innerHTML;

                        // grab images src
                        const images = marker.querySelectorAll('img');
                        var strings = [];
                        Array.from(images).forEach((item, index) => {
                            var imageSrc = item.getAttribute('src');
                            strings.push(imageSrc);
                        });
                        markerObject.images = strings;
                    }

                    objects.push(markerObject);
                });
                console.log(JSON.stringify(objects, null, 2));
                var text = JSON.stringify(objects, null, 2);

                navigator.clipboard.writeText(text).then(function() {
                    console.log('Async: Copying to clipboard was successful!');
                    alert(`Copied the config to clipboard!\nPaste into trip_config.json to save the changes`);
                }, function(err) {
                    console.error('Async: Could not copy text: ', err);
                });

            }



        </script>
    </body>