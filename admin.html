<!DOCTYPE html>
<html>
    <head>
        <title>Control Panel</title>
        <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
        <link rel="manifest" href="/assets/favicon/site.webmanifest">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>

        <style>
            * {
                /* outline: 1px solid red; */
            }
        </style>

    </head>
    <body class="bg-gray-100">

        <!--
        <div class="fixed top-2 right-2">
            <button class="bg-gray-400 hover:bg-gray-500 text-white text-sm font-bold py-2 px-4 rounded" onclick="dumpState()">
            Copy
            </button>       
        </div>
        <div class="m-4 py-1 bg-white rounded">
            <div class="m-4">
                <p class="pt-2 text-2xl font-bold">Phuket</p>
            </div>
            <div class="m-4">
                <div class="marker mt-4 bg-blue-100 rounded">
                    <div class="flex flex-row">
                        <div class="p-2 mr-2">
                            <img class="h-20" src="https://render.bitstrips.com/v2/cpanel/10217328-102140752402_2-s5-132533800_29-s1-v1.png?transparent=1&amp;palette=1&amp;width=350" />
                        </div>
                        <div class="p-2 w-full">
                            <p class="marker-name text-lg font-semibold" onclick="makeEditable(this)">Phuket International Airport</p>
                            <p class="marker-coordinates text-xs text-gray-700" onclick="makeEditable(this)">[98.3115345,8.1104865]</p>
                            <p class="marker-icon pt-2 text-xs text-gray-700" onclick="makeEditableImage(this, true)">https://render.bitstrips.com/v2/cpanel/10217328-102140752402_2-s5-132533800_29-s1-v1.png?transparent=1&amp;palette=1&amp;width=350</p>
                            <p class="marker-captions pt-2 text-sm" onclick="makeEditable(this)">Ready for the journey...</p>
                        </div>
                    </div>
                    <div id="" class="sortable-container">
                        <div class="inline-block w-36 h-full m-4">
                            <div class="h-24 w-36">
                                <img src="/assets/phuket/airport_1.jpg" class="marker-image object-cover w-full h-full rounded-md ">                
                            </div>
                            <p class="truncate text-xs text-sm w-36" onclick="makeEditableImage(this)">/assets/phuket/airport_1.jpg</p>
                            <button class="bg-red-400 hover:bg-red-500 text-white text-sm font-semibold px-1 rounded"
                                onclick="deleteImage(this.parentElement)">                            
                            x
                            </button>
                        </div>
                        <div class="inline-block w-36 h-full m-4">
                            <div class="h-24 w-36">
                                <img src="/assets/phuket/airport_2.jpg" class="marker-image object-cover w-full h-full rounded-md ">                
                            </div>
                            <p class="truncate text-xs text-sm w-36" onclick="makeEditableImage(this)">/assets/phuket/airport_2.jpg</p>
                            <button class="bg-red-400 hover:bg-red-500 text-white text-sm font-semibold px-1 rounded"
                                onclick="deleteImage(this.parentElement)">                            
                            x
                            </button>
                        </div>
                        <div class="inline-block w-36 h-full m-4">
                            <div class="h-24 w-36">
                                <img src="/assets/phuket/airport_3.jpg" class="marker-image object-cover w-full h-full rounded-md ">                
                            </div>
                            <p class="truncate text-xs text-sm w-36" onclick="makeEditableImage(this)">/assets/phuket/airport_3.jpg</p>
                            <button class="bg-red-400 hover:bg-red-500 text-white text-sm font-semibold px-1 rounded"
                                onclick="deleteImage(this.parentElement)">                            
                            x
                            </button>
                        </div>
                    </div>
                    <div class="p-2">
                        <input class="image-input hidden" type="file" accept="image/*">
                        <button class="bg-blue-400 hover:bg-blue-500 text-white text-sm font-semibold py-1 px-2 rounded"
                            onclick="addImage(this)">
                            Add Image
                        </button>
                    </div>
                </div>
                <div class="marker mt-4 bg-blue-100 rounded">
                    <div class="flex flex-row">
                        <div class="p-2 mr-2">
                            <img class="h-20" src="https://render.bitstrips.com/v2/cpanel/10219413-132533800_29-s1-102140752402_2-s5-v1.png?transparent=1&amp;palette=1&amp;width=300" />
                        </div>
                        <div class="p-2 w-full">
                            <p class="marker-name text-lg font-semibold" onclick="makeEditable(this)">Sky and Sea Condos</p>
                            <p class="marker-coordinates text-xs text-gray-700" onclick="makeEditable(this)">[98.3013584,7.8311951]</p>
                            <p class="marker-icon pt-2 text-xs text-gray-700" onclick="makeEditableImage(this, true)">https://render.bitstrips.com/v2/cpanel/10219413-132533800_29-s1-102140752402_2-s5-v1.png?transparent=1&amp;palette=1&amp;width=300</p>
                            <p class="marker-captions pt-2 text-sm" onclick="makeEditable(this)">WHAT UPPPPPPPPPP week</p>
                        </div>
                    </div>
                    <div id="" class="sortable-container">
                        <div class="inline-block w-36 h-full m-4">
                            <div class="h-24 w-36">
                                <img src="/assets/phuket/sea_and_sky_1.jpg" class="marker-image object-cover w-full h-full rounded-md ">                
                            </div>
                            <p class="truncate text-xs text-sm w-36" onclick="makeEditableImage(this)">/assets/phuket/sea_and_sky_1.jpg</p>
                            <button class="bg-red-400 hover:bg-red-500 text-white text-sm font-semibold px-1 rounded"
                                onclick="deleteImage(this.parentElement)">                            
                            x
                            </button>
                        </div>
                        <div class="inline-block w-36 h-full m-4">
                            <div class="h-24 w-36">
                                <img src="/assets/phuket/sea_and_sky_2.jpg" class="marker-image object-cover w-full h-full rounded-md ">                
                            </div>
                            <p class="truncate text-xs text-sm w-36" onclick="makeEditableImage(this)">/assets/phuket/sea_and_sky_2.jpg</p>
                            <button class="bg-red-400 hover:bg-red-500 text-white text-sm font-semibold px-1 rounded"
                                onclick="deleteImage(this.parentElement)">                            
                            x
                            </button>
                        </div>
                        <div class="inline-block w-36 h-full m-4">
                            <div class="h-24 w-36">
                                <img src="/assets/phuket/sea_and_sky_3.jpg" class="marker-image object-cover w-full h-full rounded-md ">                
                            </div>
                            <p class="truncate text-xs text-sm w-36" onclick="makeEditableImage(this)">/assets/phuket/sea_and_sky_3.jpg</p>
                            <button class="bg-red-400 hover:bg-red-500 text-white text-sm font-semibold px-1 rounded"
                                onclick="deleteImage(this.parentElement)">                            
                            x
                            </button>
                        </div>
                        <div class="inline-block w-36 h-full m-4">
                            <div class="h-24 w-36">
                                <img src="/assets/phuket/sea_and_sky_4.jpg" class="marker-image object-cover w-full h-full rounded-md ">                
                            </div>
                            <p class="truncate text-xs text-sm w-36" onclick="makeEditableImage(this)">/assets/phuket/sea_and_sky_4.jpg</p>
                            <button class="bg-red-400 hover:bg-red-500 text-white text-sm font-semibold px-1 rounded"
                                onclick="deleteImage(this.parentElement)">                            
                            x
                            </button>
                        </div>
                    </div>
                    <div class="p-2">
                        <input class="image-input hidden" type="file" accept="image/*">
                        <button class="bg-blue-400 hover:bg-blue-500 text-white text-sm font-semibold py-1 px-2 rounded"
                            onclick="addImage(this)">
                            Add Image
                        </button>
                    </div>
                </div>
            </div>
        </div>
        -->


        <script>

            const fetchData = fetch('trip_config.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('Error fetching the file:', error);
                });
            fetchData.then(data => {
                if (data) {
                    generateHTML(data);
                    initSortable();
                    initImageListener();
                }
            })


            function makeEditableImage(element, bitmoji = false) {
                console.log("makeEditableImage()");
                console.log("element", element.parentNode);

                // get the actual image element associated with this text input
                const imgElement = (bitmoji) ? 
                    element.parentNode.parentNode.querySelector('img') : 
                    element.parentNode.querySelector('img');
                const imgSrc = imgElement.getAttribute('src');

                // save the original class name
                const textClassName = element.className

                // Create a new input element and replace original element 
                const inputElement = document.createElement("input");
                inputElement.type = "text";
                inputElement.value = element.textContent
                inputElement.className = textClassName + " w-full";

                element.replaceWith(inputElement);

                // Focus on the input field to allow editing
                inputElement.focus();

                // Add an event listener to handle changes when the user presses Enter
                inputElement.addEventListener("keydown", function (event) {
                    if (event.key === "Enter") {
                        // Prevent the default Enter key behavior (e.g., form submission)
                        event.preventDefault();
                        
                        // Get the updated value from the input field
                        const updatedValue = inputElement.value;

                        // Create a new text element with the updated value
                        const textElement = document.createElement("p");
                        textElement.className = textClassName;
                        textElement.textContent = updatedValue;

                        // Replace the input field with the new text element
                        inputElement.replaceWith(textElement);

                        // update <img src> to the new value
                        console.log("updated value", updatedValue);

                        imgElement.setAttribute('src', updatedValue);

                        // Reattach the click event listener for editing
                        textElement.addEventListener("click", function () {
                            (bitmoji) ? 
                                makeEditableImage(textElement, true) :
                                makeEditableImage(textElement);
                        });
                    }
                });
            }


            // Original:
            //      <p class="editable-text" onclick="makeEditable(this)">Click me to edit</p>
            // When field is active: 
            //      <input type="text">
            function makeEditable(element) {

                // save the original class name
                const textClassName = element.className

                // Create a new input element and replace original element 
                const inputElement = document.createElement("input");
                inputElement.type = "text";
                inputElement.value = element.textContent;
                inputElement.className = textClassName + " w-full";
                element.replaceWith(inputElement);

                // Focus on the input field to allow editing
                inputElement.focus();

                // Add an event listener to handle changes when the user presses Enter
                inputElement.addEventListener("keydown", function (event) {
                    if (event.key === "Enter") {
                        // Prevent the default Enter key behavior (e.g., form submission)
                        event.preventDefault();
                        
                        // Get the updated value from the input field
                        const updatedValue = inputElement.value;

                        // Create a new text element with the updated value
                        const textElement = document.createElement("p");
                        textElement.className = textClassName;
                        textElement.textContent = updatedValue;

                        // Replace the input field with the new text element
                        inputElement.replaceWith(textElement);

                        // Reattach the click event listener for editing
                        textElement.addEventListener("click", function () {
                            makeEditable(textElement);
                        });
                    }
                });
            }


            function generateHTML(data) {
                // inject this into the body 
                const HTML = `
                    <div class="fixed top-2 right-2">
                        <button class="bg-gray-400 hover:bg-gray-500 text-white text-sm font-bold py-2 px-4 rounded" onclick="dumpState()">
                            Copy
                        </button>       
                    </div>
                    ${generateRegions(data)}
                `;
                document.body.innerHTML = HTML;
            }

            function generateRegions(data) {
                var strings = [];
                for (var i = 0; i < data.length; i++) {
                    const region = data[i];
                    strings.push(generateRegion(region));
                }
                return strings.join("\n");
            }

            function generateRegion(region) {
                const regionHTML = `
                    <div class="m-4 py-1 bg-white rounded">
                        <div class="m-4">
                            <p class="pt-2 text-2xl font-bold">${region.name}</p>
                        </div>
                        <div class="m-4">
                            ${generateMarkers(region.markers)}
                        </div>
                    </div>
                `;
                return regionHTML;
            }

            function generateMarkers(markers) {
                var strings = [];
                for (var i = 0; i < markers.length; i++) {
                    (markers[i].ignore) ? 
                        strings.push(generateHiddenMarker(markers[i])) : 
                        strings.push(generateMarker(markers[i]));
                }
                return strings.join("\n");
            }

            function generateHiddenMarker(marker) {
                const markerHTML = `
                    <div class="marker hidden">
                        <div class="p-2">
                            <p class="marker-name text-lg font-semibold">${marker.name}</p>
                            <p class="marker-coordinates text-xs text-gray-700">${JSON.stringify(marker.coordinates)}</p>
                        </div>
                    </div>
                `;
                return markerHTML;
            }

            function generateMarker(marker) {
                // console.log("marker:", marker);

                const markerHTML = `
                    <div class="marker mt-4 bg-blue-100 rounded">
                        <div class="flex flex-row">
                            <div class="p-2 mr-2">
                                <img class="h-20" src="${marker.icon}" />
                            </div>
                            <div class="p-2 w-full">
                                <p class="marker-name text-lg font-semibold" onclick="makeEditable(this)">${marker.name}</p>
                                <p class="marker-coordinates text-xs text-gray-700" onclick="makeEditable(this)">${JSON.stringify(marker.coordinates)}</p>
                                <p class="marker-icon pt-2 text-xs text-gray-700" onclick="makeEditableImage(this, true)">${marker.icon}</p>
                                <p class="marker-captions pt-2 text-sm" onclick="makeEditable(this)">${marker.captions}</p>
                            </div>
                        </div>
                        <div id="" class="sortable-container">
                            ${generateMarkerImageHTML(marker.images)}
                        </div>
                        <div class="p-2">
                            <input class="image-input hidden" type="file" accept="image/*">
                            <button class="bg-blue-400 hover:bg-blue-500 text-white text-sm font-semibold py-1 px-2 rounded"
                                onclick="addImage(this)">
                                Add Image
                            </button>
                        </div>
                    </div>
                `;
                return markerHTML;
            }

            function generateMarkerImageHTML(images) {
                var strings = [];
                for (var i = 0; i < images.length; i++) {
                    strings.push(
                        createMarkerImage(images[i])
                    );
                }
                return strings.join("\n");
            }

            function createMarkerImage(imageSrc) {
                const markerImageHTML = `
                    <div class="inline-block w-36 h-full m-4">
                        <div class="h-24 w-36">
                            <img src="${imageSrc}" class="marker-image object-cover w-full h-full rounded-md ">                
                        </div>
                        <p class="truncate text-xs text-sm w-36" onclick="makeEditableImage(this)">${imageSrc}</p>
                        <button class="bg-red-400 hover:bg-red-500 text-white text-sm font-semibold px-1 rounded"
                            onclick="deleteImage(this.parentElement)">                            
                            x
                        </button>
                    </div>
                `;
                return markerImageHTML;
            }

            // initialize the sortable list - this should apply to all Marker > Image lists
            function initSortable() {
                const sortableContainers = document.querySelectorAll('.sortable-container');
                sortableContainers.forEach((container) => {
                    const sortable = new Sortable(container, {
                        animation: 150, // Animation speed in milliseconds
                        onEnd: (evt) => {
                            // dumpState(); 
                        }, 
                    });
                });
            }

            function initImageListener() {
                const imageInputs = document.querySelectorAll('.image-input');
                imageInputs.forEach((imageInput) => {
                    console.log("imageInput", imageInput);
                    imageInput.addEventListener("change", function () {
                        const selectedImage = imageInput.files[0];
                        if (selectedImage) {

                            // TODO: UPDATE THIS HARD CODE
                            const filePrefix = "assets/koh_tao";
                            const markerHTML = createMarkerImage(`${filePrefix}/${selectedImage.name}`);

                            // find the associated sibling sortable container
                            // add the created marker image to the END of the sortable container
                            const sortableContainer = imageInput.parentElement.previousElementSibling;
                            sortableContainer.insertAdjacentHTML('beforeend', markerHTML);
                        }
                    });
                });
            }

            function deleteImage(element) {
                console.log("deleteImage()", element);
                element.remove();
            }

            function addImage(element) {
                console.log("addImage()", element);
                const imageInput = element.previousElementSibling;
                imageInput.click();
            }

            function dumpState() {
                var objects = [];

                const markers = document.querySelectorAll('.marker');
                markers.forEach((marker, index) => {

                    var markerObject = {
                        name: marker.querySelector('.marker-name').innerHTML,
                        coordinates: JSON.parse(marker.querySelector('.marker-coordinates').innerHTML)
                    };

                    if (marker.classList.contains('hidden')) {
                        markerObject.ignore = true;
                    } else {
                        markerObject.captions = marker.querySelector('.marker-captions').innerHTML;
                        markerObject.icon = marker.querySelector('.marker-icon').innerHTML;

                        // grab images src
                        const images = marker.querySelectorAll('.marker-image');
                        var strings = [];
                        Array.from(images).forEach((item, index) => {
                            var imageSrc = item.getAttribute('src');
                            strings.push(imageSrc);
                        });
                        markerObject.images = strings;
                    }

                    objects.push(markerObject);
                });
                console.log(JSON.stringify(objects, null, 2));
                var text = JSON.stringify(objects, null, 2);

                navigator.clipboard.writeText(text).then(function() {
                    console.log('Async: Copying to clipboard was successful!');
                    // alert(`Copied the config to clipboard!\nPaste into trip_config.json to save the changes`);
                }, function(err) {
                    console.error('Async: Could not copy text: ', err);
                });

            }



        </script>
    </body>